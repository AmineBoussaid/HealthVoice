<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Reconnaissance Vocale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        textarea {
            font-size: 16px;
            min-height: 150px;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .btn-record {
            font-size: 18px;
            padding: 15px 30px;
            margin: 10px 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">üé§ Test de Reconnaissance Vocale</h1>
        
        <div id="status" class="status info">
            <strong>Status:</strong> <span id="statusText">Initialisation...</span>
        </div>

        <div class="mb-3">
            <h3>Compatibilit√©</h3>
            <p id="compatibility"></p>
        </div>

        <div class="mb-3">
            <button id="btnStart" class="btn btn-success btn-record">
                <i class="bi bi-mic"></i> D√©marrer
            </button>
            <button id="btnStop" class="btn btn-danger btn-record" disabled>
                <i class="bi bi-stop-fill"></i> Arr√™ter
            </button>
            <button id="btnClear" class="btn btn-secondary btn-record">
                <i class="bi bi-trash"></i> Effacer
            </button>
        </div>

        <div class="mb-3">
            <label for="transcript" class="form-label">
                <strong>Transcription:</strong>
            </label>
            <textarea id="transcript" class="form-control" placeholder="La transcription appara√Ætra ici..."></textarea>
        </div>

        <div class="mb-3">
            <h3>Instructions</h3>
            <ol>
                <li>Cliquez sur "D√©marrer" et autorisez le microphone</li>
                <li>Parlez clairement en fran√ßais</li>
                <li>Cliquez sur "Arr√™ter" quand vous avez fini</li>
            </ol>
        </div>

        <div>
            <h3>Console de d√©bogage</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let recognition = null;
        let isRecording = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(text, type = 'info') {
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            statusDiv.className = `status ${type}`;
            statusText.textContent = text;
            log(text, type);
        }

        function checkCompatibility() {
            const compatDiv = document.getElementById('compatibility');
            let html = '<ul>';
            
            // V√©rifier Web Speech API
            if ('webkitSpeechRecognition' in window) {
                html += '<li class="text-success">‚úì webkitSpeechRecognition disponible (Chrome/Edge)</li>';
                log('webkitSpeechRecognition disponible', 'success');
            } else if ('SpeechRecognition' in window) {
                html += '<li class="text-success">‚úì SpeechRecognition disponible</li>';
                log('SpeechRecognition disponible', 'success');
            } else {
                html += '<li class="text-danger">‚úó Web Speech API non disponible</li>';
                log('Web Speech API non disponible', 'error');
            }

            // V√©rifier MediaDevices
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                html += '<li class="text-success">‚úì getUserMedia disponible</li>';
                log('getUserMedia disponible', 'success');
            } else {
                html += '<li class="text-danger">‚úó getUserMedia non disponible</li>';
                log('getUserMedia non disponible', 'error');
            }

            // V√©rifier le protocole
            if (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                html += '<li class="text-success">‚úì Protocole s√©curis√© (' + location.protocol + ')</li>';
                log('Protocole s√©curis√©: ' + location.protocol, 'success');
            } else {
                html += '<li class="text-warning">‚ö† Protocole non s√©curis√© (peut causer des probl√®mes)</li>';
                log('Protocole non s√©curis√©: ' + location.protocol, 'warning');
            }

            // Navigateur
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome')) {
                html += '<li class="text-success">‚úì Chrome d√©tect√©</li>';
            } else if (userAgent.includes('Edge')) {
                html += '<li class="text-success">‚úì Edge d√©tect√©</li>';
            } else if (userAgent.includes('Firefox')) {
                html += '<li class="text-warning">‚ö† Firefox (support limit√©)</li>';
            } else {
                html += '<li class="text-warning">‚ö† Navigateur non reconnu</li>';
            }

            html += '</ul>';
            compatDiv.innerHTML = html;
        }

        function initRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'fr-FR';

                recognition.onstart = function() {
                    isRecording = true;
                    document.getElementById('btnStart').disabled = true;
                    document.getElementById('btnStop').disabled = false;
                    updateStatus('üé§ Reconnaissance vocale active - Parlez maintenant!', 'success');
                };

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                            log('Transcription finale: ' + transcript, 'success');
                        } else {
                            interimTranscript += transcript;
                            log('Transcription interm√©diaire: ' + transcript, 'info');
                        }
                    }
                    
                    const textarea = document.getElementById('transcript');
                    if (finalTranscript) {
                        const currentValue = textarea.value.trim();
                        const separator = currentValue ? ' ' : '';
                        textarea.value = currentValue + separator + finalTranscript.trim();
                    }
                };

                recognition.onerror = function(event) {
                    let errorMessage = 'Erreur: ';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage += 'Aucune parole d√©tect√©e';
                            break;
                        case 'audio-capture':
                            errorMessage += 'Microphone non accessible';
                            break;
                        case 'not-allowed':
                            errorMessage += 'Permission refus√©e. Autorisez le microphone dans les param√®tres du navigateur.';
                            break;
                        case 'network':
                            errorMessage += 'Erreur r√©seau';
                            break;
                        default:
                            errorMessage += event.error;
                    }
                    updateStatus(errorMessage, 'error');
                };

                recognition.onend = function() {
                    isRecording = false;
                    document.getElementById('btnStart').disabled = false;
                    document.getElementById('btnStop').disabled = true;
                    updateStatus('Reconnaissance vocale arr√™t√©e', 'info');
                };

                log('Reconnaissance vocale initialis√©e avec succ√®s', 'success');
                return true;
            } else {
                updateStatus('‚ùå Web Speech API non support√©e. Utilisez Chrome ou Edge.', 'error');
                return false;
            }
        }

        document.getElementById('btnStart').addEventListener('click', function() {
            if (!recognition) {
                if (!initRecognition()) {
                    return;
                }
            }
            
            try {
                recognition.start();
                log('Tentative de d√©marrage de la reconnaissance...', 'info');
            } catch (e) {
                updateStatus('Erreur au d√©marrage: ' + e.message, 'error');
            }
        });

        document.getElementById('btnStop').addEventListener('click', function() {
            if (recognition && isRecording) {
                recognition.stop();
                log('Arr√™t de la reconnaissance...', 'info');
            }
        });

        document.getElementById('btnClear').addEventListener('click', function() {
            document.getElementById('transcript').value = '';
            document.getElementById('log').innerHTML = '';
            log('Transcription et log effac√©s', 'info');
        });

        // Initialisation
        window.addEventListener('DOMContentLoaded', function() {
            checkCompatibility();
            updateStatus('Pr√™t. Cliquez sur "D√©marrer" pour commencer.', 'info');
        });
    </script>
</body>
</html>
