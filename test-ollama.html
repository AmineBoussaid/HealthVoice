<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Ollama IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .status-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-success { background: #d4edda; color: #155724; border-left: 5px solid #28a745; }
        .status-error { background: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
        .status-warning { background: #fff3cd; color: #856404; border-left: 5px solid #ffc107; }
        .status-info { background: #d1ecf1; color: #0c5460; border-left: 5px solid #17a2b8; }
        .log-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 20px 0;
        }
        .result-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn-test {
            margin: 10px 5px;
        }
        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">ü§ñ Test d'Int√©gration Ollama</h1>
        
        <div id="statusBox" class="status-box status-info">
            <h4>üì° Status de Connexion</h4>
            <p id="statusText">V√©rification en cours...</p>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üß™ Tests Disponibles</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary btn-test" onclick="testOllamaConnection()">
                    1Ô∏è‚É£ Tester la Connexion
                </button>
                <button class="btn btn-success btn-test" onclick="testListModels()">
                    2Ô∏è‚É£ Lister les Mod√®les
                </button>
                <button class="btn btn-info btn-test" onclick="testSimpleGeneration()">
                    3Ô∏è‚É£ Test Simple
                </button>
                <button class="btn btn-warning btn-test" onclick="testMedicalAnalysis()">
                    4Ô∏è‚É£ Test Analyse M√©dicale
                </button>
                <button class="btn btn-secondary btn-test" onclick="clearLogs()">
                    üóëÔ∏è Effacer
                </button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">üìù Console de D√©bogage</h5>
            </div>
            <div class="card-body">
                <div id="logBox" class="log-box"></div>
            </div>
        </div>

        <div id="resultBox" style="display:none;">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚úÖ R√©sultat</h5>
                </div>
                <div class="card-body">
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const OLLAMA_API_URL = 'http://localhost:11434/api/generate';
        const OLLAMA_TAGS_URL = 'http://localhost:11434/api/tags';
        const OLLAMA_MODEL = 'gpt-oss:120b-cloud'; // Changez selon votre mod√®le

        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#0dcaf0',
                success: '#198754',
                error: '#dc3545',
                warning: '#ffc107'
            };
            const color = colors[type] || colors.info;
            
            logBox.innerHTML += `<div style="color: ${color}; margin: 5px 0;">
                <strong>[${timestamp}]</strong> ${message}
            </div>`;
            logBox.scrollTop = logBox.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusBox = document.getElementById('statusBox');
            const statusText = document.getElementById('statusText');
            
            statusBox.className = `status-box status-${type}`;
            statusText.textContent = message;
            
            log(message, type);
        }

        function showResult(content) {
            const resultBox = document.getElementById('resultBox');
            const resultContent = document.getElementById('resultContent');
            
            resultContent.innerHTML = content;
            resultBox.style.display = 'block';
        }

        function clearLogs() {
            document.getElementById('logBox').innerHTML = '';
            document.getElementById('resultBox').style.display = 'none';
            log('Logs effac√©s', 'info');
        }

        async function testOllamaConnection() {
            log('üîç Test de connexion √† Ollama...', 'info');
            
            try {
                const response = await fetch(OLLAMA_TAGS_URL);
                
                if (response.ok) {
                    updateStatus('‚úÖ Ollama est connect√© et op√©rationnel !', 'success');
                    log('‚úì Connexion r√©ussie', 'success');
                    showResult('<p class="text-success fs-4">‚úÖ Ollama fonctionne correctement !</p>');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('‚ùå Impossible de se connecter √† Ollama', 'error');
                log('‚úó Erreur: ' + error.message, 'error');
                showResult(`
                    <div class="alert alert-danger">
                        <h5>‚ùå √âchec de la connexion</h5>
                        <p><strong>Erreur:</strong> ${error.message}</p>
                        <hr>
                        <h6>Solutions :</h6>
                        <ol>
                            <li>V√©rifiez qu'Ollama est install√©</li>
                            <li>Lancez : <code>ollama serve</code> dans le terminal</li>
                            <li>V√©rifiez l'URL : <a href="${OLLAMA_TAGS_URL}" target="_blank">${OLLAMA_TAGS_URL}</a></li>
                        </ol>
                    </div>
                `);
            }
        }

        async function testListModels() {
            log('üìã R√©cup√©ration de la liste des mod√®les...', 'info');
            
            try {
                const response = await fetch(OLLAMA_TAGS_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.models && data.models.length > 0) {
                    updateStatus(`‚úÖ ${data.models.length} mod√®le(s) trouv√©(s)`, 'success');
                    log(`‚úì ${data.models.length} mod√®le(s) disponible(s)`, 'success');
                    
                    let modelsHtml = '<h5>Mod√®les install√©s :</h5><ul class="list-group">';
                    data.models.forEach(model => {
                        const size = (model.size / (1024 * 1024 * 1024)).toFixed(2);
                        modelsHtml += `
                            <li class="list-group-item">
                                <strong>${model.name}</strong><br>
                                <small>Taille: ${size} GB | Modifi√©: ${new Date(model.modified_at).toLocaleString()}</small>
                            </li>
                        `;
                        log(`  - ${model.name} (${size} GB)`, 'info');
                    });
                    modelsHtml += '</ul>';
                    
                    // V√©rifier si le mod√®le configur√© existe
                    const modelExists = data.models.some(m => m.name.includes(OLLAMA_MODEL));
                    if (modelExists) {
                        modelsHtml += `<div class="alert alert-success mt-3">‚úÖ Le mod√®le configur√© <code>${OLLAMA_MODEL}</code> est disponible</div>`;
                        log(`‚úì Mod√®le '${OLLAMA_MODEL}' trouv√©`, 'success');
                    } else {
                        modelsHtml += `<div class="alert alert-warning mt-3">‚ö†Ô∏è Le mod√®le <code>${OLLAMA_MODEL}</code> n'est pas install√©. Installez-le avec: <code>ollama pull ${OLLAMA_MODEL}</code></div>`;
                        log(`‚ö† Mod√®le '${OLLAMA_MODEL}' non trouv√©`, 'warning');
                    }
                    
                    showResult(modelsHtml);
                } else {
                    updateStatus('‚ö†Ô∏è Aucun mod√®le install√©', 'warning');
                    showResult(`
                        <div class="alert alert-warning">
                            <h5>‚ö†Ô∏è Aucun mod√®le trouv√©</h5>
                            <p>Installez un mod√®le avec :</p>
                            <pre>ollama pull llama3.2</pre>
                        </div>
                    `);
                }
            } catch (error) {
                updateStatus('‚ùå Erreur lors de la r√©cup√©ration des mod√®les', 'error');
                log('‚úó Erreur: ' + error.message, 'error');
                showResult(`<div class="alert alert-danger">Erreur: ${error.message}</div>`);
            }
        }

        async function testSimpleGeneration() {
            log('üß™ Test de g√©n√©ration simple...', 'info');
            updateStatus('‚è≥ G√©n√©ration en cours... (peut prendre 10-30 secondes)', 'warning');
            
            const testPrompt = "Dis bonjour en une phrase.";
            
            try {
                log(`Prompt: "${testPrompt}"`, 'info');
                
                const startTime = Date.now();
                const response = await fetch(OLLAMA_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: OLLAMA_MODEL,
                        prompt: testPrompt,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                updateStatus(`‚úÖ Test simple r√©ussi en ${duration}s`, 'success');
                log(`‚úì R√©ponse re√ßue en ${duration}s`, 'success');
                log(`R√©ponse: ${data.response}`, 'success');
                
                showResult(`
                    <div class="alert alert-success">
                        <h5>‚úÖ G√©n√©ration R√©ussie</h5>
                        <p><strong>Temps:</strong> ${duration} secondes</p>
                        <p><strong>R√©ponse:</strong></p>
                        <div class="alert alert-light">${data.response}</div>
                    </div>
                `);
            } catch (error) {
                updateStatus('‚ùå Erreur lors de la g√©n√©ration', 'error');
                log('‚úó Erreur: ' + error.message, 'error');
                showResult(`<div class="alert alert-danger">Erreur: ${error.message}</div>`);
            }
        }

        async function testMedicalAnalysis() {
            log('üè• Test d\'analyse m√©dicale...', 'info');
            updateStatus('‚è≥ Analyse en cours... (peut prendre 20-60 secondes)', 'warning');
            
            const symptome = "Toux";
            const intensite = "Forte";
            const transcription = "Le patient pr√©sente une toux s√®che persistante depuis 3 jours, accompagn√©e de difficult√©s respiratoires l√©g√®res et d'une l√©g√®re douleur thoracique. Pas de fi√®vre constat√©e.";
            
            const prompt = `Tu es un assistant m√©dical expert. Analyse les sympt√¥mes suivants et fournis une analyse structur√©e.

Sympt√¥me: ${symptome}
Intensit√©: ${intensite}
Description du patient: ${transcription}

Fournis ta r√©ponse au format JSON strict suivant (ne retourne QUE le JSON, sans texte avant ou apr√®s):
{
  "categorie": "Respiratoire|Cardiovasculaire|Neurologique|Digestif|G√©n√©ral|Autre",
  "resume": "Un r√©sum√© concis des sympt√¥mes observ√©s (2-3 phrases)",
  "recommandations": "Des recommandations m√©dicales appropri√©es (2-3 phrases)"
}

Important: 
- Choisis UNE SEULE cat√©gorie parmi: Respiratoire, Cardiovasculaire, Neurologique, Digestif, G√©n√©ral, Autre
- Sois concis et professionnel
- Base-toi uniquement sur les informations fournies
- Ne retourne QUE le JSON, rien d'autre`;

            try {
                log('Envoi du prompt √† Ollama...', 'info');
                log(`Sympt√¥me: ${symptome}`, 'info');
                log(`Intensit√©: ${intensite}`, 'info');
                
                const startTime = Date.now();
                const response = await fetch(OLLAMA_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: OLLAMA_MODEL,
                        prompt: prompt,
                        stream: false,
                        options: {
                            temperature: 0.3,
                            top_p: 0.9
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                log(`‚úì R√©ponse re√ßue en ${duration}s`, 'success');
                log('R√©ponse brute: ' + data.response.substring(0, 100) + '...', 'info');
                
                // Extraire le JSON
                let jsonMatch = data.response.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('Pas de JSON trouv√© dans la r√©ponse');
                }
                
                const analysis = JSON.parse(jsonMatch[0]);
                log('‚úì JSON pars√© avec succ√®s', 'success');
                log(`Cat√©gorie: ${analysis.categorie}`, 'info');
                
                // Valider
                const validCategories = ['Respiratoire', 'Cardiovasculaire', 'Neurologique', 'Digestif', 'G√©n√©ral', 'Autre'];
                if (!validCategories.includes(analysis.categorie)) {
                    log('‚ö† Cat√©gorie non valide, d√©faut √† "Autre"', 'warning');
                    analysis.categorie = 'Autre';
                }
                
                updateStatus(`‚úÖ Analyse m√©dicale g√©n√©r√©e en ${duration}s`, 'success');
                
                showResult(`
                    <div class="alert alert-success">
                        <h5>‚úÖ Analyse M√©dicale G√©n√©r√©e</h5>
                        <p><strong>Temps:</strong> ${duration} secondes</p>
                    </div>
                    
                    <h5>üìã Donn√©es d'Entr√©e</h5>
                    <ul>
                        <li><strong>Sympt√¥me:</strong> ${symptome}</li>
                        <li><strong>Intensit√©:</strong> ${intensite}</li>
                        <li><strong>Transcription:</strong> ${transcription}</li>
                    </ul>
                    
                    <h5>ü§ñ R√©sultat de l'Analyse IA</h5>
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <strong>Cat√©gorie:</strong> ${analysis.categorie}
                        </div>
                        <div class="card-body">
                            <h6>R√©sum√©:</h6>
                            <p>${analysis.resume}</p>
                            <h6>Recommandations:</h6>
                            <p>${analysis.recommandations}</p>
                        </div>
                    </div>
                    
                    <h6>JSON Complet:</h6>
                    <pre>${JSON.stringify(analysis, null, 2)}</pre>
                `);
            } catch (error) {
                updateStatus('‚ùå Erreur lors de l\'analyse', 'error');
                log('‚úó Erreur: ' + error.message, 'error');
                showResult(`
                    <div class="alert alert-danger">
                        <h5>‚ùå Erreur</h5>
                        <p>${error.message}</p>
                    </div>
                `);
            }
        }

        // Test automatique au chargement
        window.addEventListener('DOMContentLoaded', async function() {
            log('üöÄ D√©marrage des tests...', 'info');
            await testOllamaConnection();
        });
    </script>
</body>
</html>
